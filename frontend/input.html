<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>å…¥åŠ› - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
  <style>
    :root {
      --main:      #4A90E2;
      --main-dark: #357ABD;
      --bg:        #F5F5F5;
      --white:     #FFFFFF;
      --text:      #333333;
      --sub:       #888888;
      --border:    #E0E0E0;
      --nav-h:     60px;
      --hdr-h:     54px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
    }

    /* ========= ãƒ˜ãƒƒãƒ€ãƒ¼ ========= */
    .hdr {
      position: fixed; top: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      height: var(--hdr-h);
      background: var(--main);
      display: flex; align-items: center;
      padding: 0 16px;
      z-index: 200;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .hdr h1 { font-size: 1.1rem; font-weight: 700; color: #fff; }

    /* ========= ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========= */
    .content {
      padding-top: calc(var(--hdr-h) + 12px);
      padding-bottom: calc(var(--nav-h) + 20px);
      padding-left: 14px;
      padding-right: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ========= ã‚«ãƒ¼ãƒ‰ ========= */
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 20px 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,.07);
    }
    .card-header {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 14px;
    }
    .card-icon {
      width: 34px; height: 34px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
    }
    .card-icon.add    { background: #dbeafe; }
    .card-icon.search { background: #f3e8ff; }
    .card-title {
      font-size: 0.98rem; font-weight: 700; color: var(--text);
    }
    .card-desc {
      font-size: 0.78rem; color: var(--sub); margin-top: 1px;
    }

    /* ========= ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  ========= */
    textarea {
      width: 100%;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      padding: 12px 13px;
      font-size: 0.9rem;
      font-family: inherit;
      resize: none;
      min-height: 82px;
      line-height: 1.55;
      outline: none;
      color: var(--text);
      transition: border-color .2s;
      background: #fafafa;
    }
    textarea:focus { border-color: var(--main); background: var(--white); }

    .hint {
      font-size: 0.72rem; color: var(--sub);
      margin-top: 6px; line-height: 1.5;
    }
    .hint strong { color: #555; }

    .btn-primary {
      width: 100%; margin-top: 12px;
      padding: 13px;
      background: var(--main);
      color: #fff; border: none;
      border-radius: 10px;
      font-size: 0.92rem; font-weight: 700;
      cursor: pointer;
      transition: background .15s, opacity .15s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-primary:hover    { background: var(--main-dark); }
    .btn-primary:disabled { opacity: .55; cursor: not-allowed; }

    .btn-search {
      background: #7c3aed;
    }
    .btn-search:hover { background: #6d28d9; }

    /* ========= ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ========= */
    .msg {
      font-size: 0.82rem;
      padding: 10px 13px;
      border-radius: 9px;
      margin-top: 10px;
      display: none;
      line-height: 1.5;
    }
    .msg.success { background: #dcfce7; color: #166534; display: block; }
    .msg.error   { background: #fee2e2; color: #991b1b; display: block; }
    .msg.warning { background: #fef3c7; color: #92400e; display: block; }
    .msg.loading { background: #e0e7ff; color: #3730a3; display: block; }

    /* ========= ã‚¹ãƒ”ãƒŠãƒ¼ ========= */
    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }
    .spinner.dark {
      border-color: rgba(55,48,163,.3);
      border-top-color: #3730a3;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========= ä¸‹éƒ¨ãƒŠãƒ“ ========= */
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      height: var(--nav-h);
      background: var(--white);
      border-top: 1px solid var(--border);
      display: flex; z-index: 200;
      box-shadow: 0 -2px 8px rgba(0,0,0,.06);
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
      text-decoration: none; color: var(--sub);
      font-size: 0.65rem; font-weight: 500;
      transition: color .15s;
    }
    .nav-item.active { color: var(--main); }
    .nav-icon { font-size: 1.25rem; line-height: 1; }
  </style>
</head>
<body>

<header class="hdr">
  <h1>äºˆå®šå…¥åŠ›</h1>
</header>

<main class="content">

  <!-- ===== äºˆå®šè¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon add">ğŸ“…</div>
      <div>
        <div class="card-title">äºˆå®šã‚’è¿½åŠ </div>
        <div class="card-desc">è‡ªç„¶ãªè¨€è‘‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
    </div>

    <textarea id="addInput" rows="3"
      placeholder="ä¾‹: æ˜æ—¥18æ™‚ã‹ã‚‰1æ™‚é–“ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼šè­°&#10;ä¾‹: 3/15 çµ‚æ—¥ã€è³‡æ–™æå‡ºç· åˆ‡"></textarea>

    <p class="hint">
      <strong>ä½¿ã„æ–¹:</strong> æ—¥æ™‚ãƒ»å†…å®¹ã‚’è‡ªç„¶ãªæ–‡ç« ã§æ›¸ãã¨ AI ãŒè‡ªå‹•åˆ¤æ–­ã—ã¾ã™ã€‚<br>
      ç¨®åˆ¥ (ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£/ç· åˆ‡/ãƒ–ãƒ­ãƒƒã‚¯) ã‚‚èªè­˜ã—ã¾ã™ã€‚
    </p>

    <div id="addMsg" class="msg"></div>

    <button class="btn-primary" id="addBtn" onclick="addEvent()">
      è¿½åŠ ã™ã‚‹
    </button>
  </div>

  <!-- ===== AIæ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
  <div class="card">
    <div class="card-header">
      <div class="card-icon search">ğŸ”</div>
      <div>
        <div class="card-title">AI æ¤œç´¢</div>
        <div class="card-desc">æœŸé–“ãƒ»æ¡ä»¶ã‚’è‡ªç„¶ãªè¨€è‘‰ã§æŒ‡å®š</div>
      </div>
    </div>

    <textarea id="searchInput" rows="3"
      placeholder="ä¾‹: 3/10ã‹ã‚‰ä¸€é€±é–“ã®äºˆå®šã‚’æ•™ãˆã¦&#10;ä¾‹: ä»Šæœˆã®ç· åˆ‡ã‚’ã¾ã¨ã‚ã¦&#10;ä¾‹: æ¥é€±ã®ä¼šè­°ã¯ä½•ãŒã‚ã‚‹ï¼Ÿ"></textarea>

    <p class="hint">
      <strong>ä½¿ã„æ–¹:</strong> èª¿ã¹ãŸã„æœŸé–“ã‚„æ¡ä»¶ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è©²å½“ã™ã‚‹äºˆå®šã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚
    </p>

    <div id="searchMsg" class="msg"></div>

    <button class="btn-primary btn-search" id="searchBtn" onclick="searchEvents()">
      æ¤œç´¢ã™ã‚‹
    </button>
  </div>

</main>

<nav class="bottom-nav">
  <a href="/home/" class="nav-item">
    <span class="nav-icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span>
  </a>
  <a href="/input/" class="nav-item active">
    <span class="nav-icon">â•</span><span>å…¥åŠ›</span>
  </a>
  <a href="/result/" class="nav-item">
    <span class="nav-icon">ğŸ”</span><span>çµæœ</span>
  </a>
</nav>

<script>
  const API_SCHEDULE = 'http://localhost:8000/api/schedule';
  const USER_ID      = 'user1';

  // ---- äºˆå®šè¿½åŠ  ----
  async function addEvent() {
    const input = document.getElementById('addInput').value.trim();
    if (!input) {
      showMsg('addMsg', 'error', 'äºˆå®šã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const btn = document.getElementById('addBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> è¿½åŠ ä¸­â€¦';
    showMsg('addMsg', 'loading', '<span class="spinner dark"></span> AIãŒäºˆå®šã‚’è§£æä¸­ã§ã™â€¦');

    try {
      const res  = await fetch(`${API_SCHEDULE}/add-event/`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ user_id: USER_ID, input }),
      });
      const data = await res.json();

      if (!res.ok || data.status === 'error') {
        throw new Error(data.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // è¡çªè­¦å‘Šãƒã‚§ãƒƒã‚¯
      const msg = data.message || '';
      if (msg.includes('è¡çª') || msg.includes('é‡è¤‡') || msg.includes('conflict')) {
        showMsg('addMsg', 'warning', `âš ï¸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¡çªãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:\n${msg}`);
      } else {
        showMsg('addMsg', 'success', 'âœ… äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        document.getElementById('addInput').value = '';
        setTimeout(() => hideMsg('addMsg'), 4000);
      }

    } catch (e) {
      showMsg('addMsg', 'error', `âŒ ${e.message}`);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'è¿½åŠ ã™ã‚‹';
    }
  }

  // ---- AIæ¤œç´¢ ----
  async function searchEvents() {
    const input = document.getElementById('searchInput').value.trim();
    if (!input) {
      showMsg('searchMsg', 'error', 'æ¤œç´¢ã™ã‚‹æœŸé–“ã‚„æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const btn = document.getElementById('searchBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> æ¤œç´¢ä¸­â€¦';
    showMsg('searchMsg', 'loading', '<span class="spinner dark"></span> AIãŒæ¤œç´¢ã—ã¦ã„ã¾ã™â€¦');

    try {
      const res  = await fetch(`${API_SCHEDULE}/get-events/`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ user_id: USER_ID, period: input }),
      });
      const data = await res.json();

      if (!res.ok || data.status === 'error') {
        throw new Error(data.message || 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // çµæœã‚’ sessionStorage ã«ä¿å­˜ã—ã¦ result.html ã¸é·ç§»
      sessionStorage.setItem('search_query',   input);
      sessionStorage.setItem('search_results', JSON.stringify(data.events || []));
      sessionStorage.setItem('search_ts',      Date.now());

      window.location.href = '/result/';

    } catch (e) {
      showMsg('searchMsg', 'error', `âŒ ${e.message}`);
      btn.disabled = false;
      btn.innerHTML = 'æ¤œç´¢ã™ã‚‹';
    }
  }

  // ---- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ----
  function showMsg(id, type, html) {
    const el = document.getElementById(id);
    el.className = `msg ${type}`;
    el.innerHTML = html;
    el.style.display = 'block';
  }
  function hideMsg(id) {
    const el = document.getElementById(id);
    el.style.display = 'none';
  }


</script>
</body>
</html>
