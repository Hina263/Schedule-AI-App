<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>æ¤œç´¢çµæœ - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
  <style>
    :root {
      --main:      #4A90E2;
      --main-dark: #357ABD;
      --main-light:#E8F2FC;
      --bg:        #F5F5F5;
      --white:     #FFFFFF;
      --text:      #333333;
      --sub:       #888888;
      --border:    #E0E0E0;
      --nav-h:     60px;
      --hdr-h:     54px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
    }

    /* ========= ãƒ˜ãƒƒãƒ€ãƒ¼ ========= */
    .hdr {
      position: fixed; top: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      height: var(--hdr-h);
      background: var(--main);
      display: flex; align-items: center;
      padding: 0 16px; gap: 10px;
      z-index: 200;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .back-btn {
      background: rgba(255,255,255,.2);
      border: none; border-radius: 8px;
      width: 32px; height: 32px;
      color: #fff; font-size: 1rem;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: background .15s;
    }
    .back-btn:active { background: rgba(255,255,255,.35); }
    .hdr h1 { font-size: 1.05rem; font-weight: 700; color: #fff; }

    /* ========= ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========= */
    .content {
      padding-top: calc(var(--hdr-h) + 12px);
      padding-bottom: calc(var(--nav-h) + 20px);
      padding-left: 14px;
      padding-right: 14px;
    }

    /* ========= æ¤œç´¢æƒ…å ±ãƒãƒŠãƒ¼ ========= */
    .query-banner {
      background: var(--main-light);
      border: 1px solid #bdd7f5;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 14px;
    }
    .query-label {
      font-size: 0.7rem; font-weight: 600;
      color: var(--main); margin-bottom: 4px;
      text-transform: uppercase; letter-spacing: .5px;
    }
    .query-text {
      font-size: 0.92rem; font-weight: 600; color: #1d4ed8;
    }
    .result-count {
      margin-top: 6px;
      font-size: 0.78rem; color: var(--sub);
    }

    /* ========= çµæœãƒªã‚¹ãƒˆ ========= */
    .result-list { display: flex; flex-direction: column; gap: 8px; }

    .ev-card {
      background: var(--white);
      border-radius: 12px;
      padding: 14px 16px;
      display: flex; gap: 10px; align-items: flex-start;
      box-shadow: 0 1px 4px rgba(0,0,0,.06);
      border-left: 4px solid transparent;
    }
    .ev-card.activity { border-left-color: #4A90E2; }
    .ev-card.deadline { border-left-color: #E25C5C; }
    .ev-card.block    { border-left-color: #E2A44A; }

    .ev-left { min-width: 58px; }
    .ev-date {
      font-size: 0.7rem; font-weight: 700; color: var(--main);
      margin-bottom: 1px;
    }
    .ev-time {
      font-size: 0.68rem; color: var(--sub); line-height: 1.4;
    }

    .ev-right { flex: 1; min-width: 0; }
    .ev-title {
      font-size: 0.92rem; font-weight: 600;
      margin-bottom: 4px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .ev-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .badge {
      display: inline-block; font-size: 0.65rem;
      padding: 1px 7px; border-radius: 4px; font-weight: 500;
    }
    .badge.activity { background: #dbeafe; color: #1d4ed8; }
    .badge.deadline { background: #fee2e2; color: #b91c1c; }
    .badge.block    { background: #fef3c7; color: #92400e; }
    .badge.allday   { background: #e0e7ff; color: #3730a3; }
    .badge.priority { background: #f3f4f6; color: #374151; }

    /* ========= å‰Šé™¤ãƒœã‚¿ãƒ³ ========= */
    .del-btn {
      flex-shrink: 0;
      background: none;
      border: none;
      color: #ccc;
      font-size: 1rem;
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 5px;
      transition: color .15s, background .15s;
      line-height: 1;
      align-self: flex-start;
    }
    .del-btn:hover { color: #ef4444; background: #fee2e2; }

    /* ========= ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ ========= */
    .group-header {
      font-size: 0.75rem; font-weight: 700;
      color: var(--sub);
      padding: 6px 4px 4px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 6px; margin-top: 10px;
    }

    /* ========= çŠ¶æ…‹è¡¨ç¤º ========= */
    .state-box {
      text-align: center; padding: 50px 20px;
      color: var(--sub); font-size: 0.9rem;
    }
    .state-icon { font-size: 2.5rem; margin-bottom: 10px; }
    .state-box p { margin-top: 4px; }

    .err-box {
      background: #fee2e2; color: #b91c1c;
      padding: 12px 14px; border-radius: 10px;
      font-size: 0.82rem; line-height: 1.5;
    }

    /* ========= å†æ¤œç´¢ãƒœã‚¿ãƒ³ ========= */
    .btn-back {
      display: block; width: 100%;
      margin-top: 20px; padding: 13px;
      background: var(--white);
      border: 1.5px solid var(--main);
      border-radius: 10px;
      color: var(--main);
      font-size: 0.9rem; font-weight: 700;
      text-align: center; text-decoration: none;
      cursor: pointer;
      transition: background .15s;
    }
    .btn-back:hover { background: var(--main-light); }

    /* ========= ä¸‹éƒ¨ãƒŠãƒ“ ========= */
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      height: var(--nav-h);
      background: var(--white);
      border-top: 1px solid var(--border);
      display: flex; z-index: 200;
      box-shadow: 0 -2px 8px rgba(0,0,0,.06);
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
      text-decoration: none; color: var(--sub);
      font-size: 0.65rem; font-weight: 500;
      transition: color .15s;
    }
    .nav-item.active { color: var(--main); }
    .nav-icon { font-size: 1.25rem; line-height: 1; }
  </style>
</head>
<body>

<header class="hdr">
  <button class="back-btn" onclick="history.back()">&#8592;</button>
  <h1>AI æ¤œç´¢çµæœ</h1>
</header>

<main class="content" id="mainContent">
  <!-- JS ã§æç”» -->
</main>

<nav class="bottom-nav">
  <a href="/home/" class="nav-item">
    <span class="nav-icon">ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span>
  </a>
  <a href="/input/" class="nav-item">
    <span class="nav-icon">â•</span><span>å…¥åŠ›</span>
  </a>
  <a href="/result/" class="nav-item active">
    <span class="nav-icon">ğŸ”</span><span>çµæœ</span>
  </a>
</nav>

<script>
  const API_SCHEDULE = 'http://localhost:8000/api/schedule';
  const USER_ID      = 'user1';

  // ---- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ----
  const query   = sessionStorage.getItem('search_query')   || '';
  const rawData = sessionStorage.getItem('search_results') || '[]';
  const ts      = parseInt(sessionStorage.getItem('search_ts') || '0');
  let events = [];
  try { events = JSON.parse(rawData); } catch(e) { events = []; }

  const main = document.getElementById('mainContent');

  // ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
  function esc(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function evDate(ev) { return ev.start ? ev.start.slice(0,10) : null; }
  function fmtDate(s) {
    if (!s) return '';
    const [y,m,d] = s.split('-');
    const dt = new Date(+y, +m-1, +d);
    const dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dt.getDay()];
    return `${+m}/${+d} (${dow})`;
  }
  function fmtTime(s) { return s && s.includes(' ') ? s.split(' ')[1] : ''; }
  function typeLbl(t) {
    return ({activity:'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£', deadline:'ç· åˆ‡', block:'ãƒ–ãƒ­ãƒƒã‚¯'})[t] || t || 'ä¸æ˜';
  }
  function priorityLbl(p) {
    return ({1:'æœ€é‡è¦',2:'é‡è¦',3:'æ™®é€š',4:'ä½',5:'æœ€ä½'})[p] || '';
  }

  // ---- æ¤œç´¢çµæœãªã— / ã‚¯ã‚¨ãƒªãªã— ----
  if (!query) {
    main.innerHTML = `
      <div class="state-box">
        <div class="state-icon">ğŸ”</div>
        <strong>æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</strong>
        <p>å…¥åŠ›ç”»é¢ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„</p>
      </div>
      <a href="/input/" class="btn-back">â† å…¥åŠ›ç”»é¢ã¸</a>`;
    stopHere();
  }

  function stopHere() { throw new Error('stop'); }

  // ---- æ¤œç´¢çµæœã®æœŸé–“ã‚’æ¨å®š ----
  function getDateRange(events) {
    const dates = events.map(ev => evDate(ev)).filter(Boolean).sort();
    if (!dates.length) return '';
    const first = fmtDate(dates[0]);
    const last  = fmtDate(dates[dates.length - 1]);
    return first === last ? first : `${first} ã€œ ${last}`;
  }

  // ---- æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ– ----
  function groupByDate(events) {
    const groups = {};
    events.forEach(ev => {
      const k = evDate(ev) || 'æ—¥ä»˜æœªå®š';
      (groups[k] = groups[k] || []).push(ev);
    });
    return groups;
  }

  // ---- æç”» ----
  try {
    const range  = getDateRange(events);
    const groups = groupByDate(events);
    const count  = events.length;

    let html = '';

    // æ¤œç´¢ã‚¯ã‚¨ãƒªãƒãƒŠãƒ¼
    html += `<div class="query-banner">
      <div class="query-label">æ¤œç´¢ã‚¯ã‚¨ãƒª</div>
      <div class="query-text">${esc(query)}</div>
      <div class="result-count">`;
    if (range) html += `ğŸ“… ${esc(range)} &ensp;|&ensp; `;
    html += `${count} ä»¶ã®äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>
    </div>`;

    if (count === 0) {
      html += `<div class="state-box">
        <div class="state-icon">ğŸ“­</div>
        <strong>è©²å½“ã™ã‚‹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</strong>
        <p>åˆ¥ã®æœŸé–“ã‚„æ¡ä»¶ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
      </div>`;
    } else {
      html += `<div class="result-list">`;

      const sortedDates = Object.keys(groups).sort();
      sortedDates.forEach(dateStr => {
        const dayEvents = groups[dateStr];
        html += `<div class="group-header">ğŸ“… ${dateStr === 'æ—¥ä»˜æœªå®š' ? 'æ—¥ä»˜æœªå®š' : fmtDate(dateStr)}</div>`;

        dayEvents.forEach(ev => {
          const type = ev.type || 'activity';
          const st   = fmtTime(ev.start);
          const en   = fmtTime(ev.end);
          const pLbl = priorityLbl(ev.priority);

          html += `<div class="ev-card ${type}">
            <div class="ev-left">
              <div class="ev-date">${dateStr === 'æ—¥ä»˜æœªå®š' ? 'æœªå®š' : fmtDate(dateStr)}</div>
              <div class="ev-time">`;
          if (ev.is_all_day) {
            html += `çµ‚æ—¥`;
          } else if (st) {
            html += esc(st);
            if (en) html += `<br>${esc(en)}`;
          }
          html += `</div>
            </div>
            <div class="ev-right">
              <div class="ev-title">${esc(ev.title)}</div>
              <div class="ev-meta">
                <span class="badge ${type}">${typeLbl(type)}</span>`;
          if (ev.is_all_day) html += `<span class="badge allday">çµ‚æ—¥</span>`;
          if (pLbl) html += `<span class="badge priority">${esc(pLbl)}</span>`;
          if (ev.category && ev.category.length) {
            ev.category.slice(0,2).forEach(c => {
              html += `<span class="badge priority">${esc(c)}</span>`;
            });
          }
          html += `</div>
            </div>
            <button class="del-btn" onclick="deleteEvent(${ev.id},this)" title="å‰Šé™¤">âœ•</button>
          </div>`;
        });
      });

      html += `</div>`;
    }

    // æˆ»ã‚‹ãƒœã‚¿ãƒ³
    html += `<a href="/input/" class="btn-back">â† å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</a>`;

    main.innerHTML = html;
  } catch(e) {
    if (e.message !== 'stop') {
      main.innerHTML = `<div class="err-box">
        âŒ è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${esc(e.message)}
      </div>
      <a href="/input/" class="btn-back">â† å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</a>`;
    }
  }

  // ---- å‰Šé™¤ ----
  async function deleteEvent(eventId, btn) {
    const card  = btn.closest('.ev-card');
    const title = card.querySelector('.ev-title')?.textContent || 'äºˆå®š';
    if (!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

    btn.disabled = true;
    btn.textContent = 'â€¦';

    try {
      const res = await fetch(`${API_SCHEDULE}/events/${eventId}/`, {
        method:  'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ user_id: USER_ID }),
      });
      if (!res.ok) {
        const d = await res.json().catch(() => ({}));
        throw new Error(d.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦ã‹ã‚‰å‰Šé™¤
      card.style.transition = 'opacity .3s';
      card.style.opacity = '0';
      setTimeout(() => {
        card.style.transition = 'max-height .25s, padding .25s, margin .25s';
        card.style.overflow = 'hidden';
        card.style.maxHeight = card.offsetHeight + 'px';
        requestAnimationFrame(() => {
          card.style.maxHeight = '0';
          card.style.paddingTop = '0';
          card.style.paddingBottom = '0';
          card.style.marginTop = '0';
          card.style.marginBottom = '0';
        });
        setTimeout(() => card.remove(), 260);
      }, 300);

      // sessionStorage ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
      events = events.filter(ev => ev.id !== eventId);
      sessionStorage.setItem('search_results', JSON.stringify(events));

    } catch (e) {
      alert(e.message);
      btn.disabled = false;
      btn.textContent = 'âœ•';
    }
  }
</script>
</body>
</html>
